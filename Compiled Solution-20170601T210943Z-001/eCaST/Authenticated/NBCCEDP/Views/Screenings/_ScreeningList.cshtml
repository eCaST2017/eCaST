@model IEnumerable<eCaST.ViewModels.ScreeningViewModel>


@{
    ViewBag.Title = "Index";
}



<style type="text/css">
    table.dataTable td.sorting_1 {
        background-color: white;
        border-top: 1px #666;
        border: 2px #666;
    }

    table.dataTable td {
        background-color: white;
        border-top: 1px #666;
        border: 1px #666;
    }

    table.dataTable tr.odd {
        background-color: white;
        border-top: 1px #666;
        border: 1px #666;
    }

    table.dataTable tr.even {
        background-color: white;
        border-top: 1px #666;
        border: 1px #666;
    }
</style>


    <div id="AddScreeningButtonContainer" style="display:block" align="right">
    <br />
        @if (ViewBag.BillingCheck > 0) { 
    <a id="BillingSummaryButton" href="#" class="btn btn-default"><i class="fa fa-university" aria-hidden="true"></i>&nbsp;Billing</a>

        }
        else
        {

            <button style="opacity:0.5" id="BillingSummaryButton" disabled="disabled" class="btn btn-default"><i class="fa fa-university" aria-hidden="true"></i>&nbsp;Billing</button>

        }    
            <button id="NewScreeningListButton" class="btn btn-success"><span class="glyphicon glyphicon-plus-sign"></span>&nbsp;Add New Screening</button>
    <br />
    <br />
        </div>

<div class="panel panel-default">
    <div class="panel-heading">
       <h4><span><i class="fa fa-heartbeat"></i>&nbsp;Screenings</span></h4>

      

    </div>

    <div class="panel-body">



        <div id="PendingScreeningErrorsPanel">



            <div id="ScreeningErrorListPanel">

                <div id="scrList">

                    <div id="messageDiv" style="display:none">There are currently (0) @ViewBag.ScreenTypeLabel (s).</div>

                    <div id="ScreeningErrorSection">




                        <div>
                            @*<table style="width:100%" class="table table-striped table-bordered" id="ScreeningList">*@
                            @*<table id="ScreeningList" class="display nowrap dataTable collapsed dtr-inline" cellspacing="0" width="100%" role="grid" aria-describedby="example_info" style="width: 100%;">

            <thead>
                <tr role="row">*@
                            <table id="ScreeningList" class="display nowrap" cellspacing="0" width="100%">
                                <thead>
                                    <tr>

                                        <th></th>
                                        <th>Screen ID</th>

                                        <th>Screening Date</th>
                                        @*<th>Client ID</th>*@



                                        @*<th>Name</th>*@




                                        <th>Screen Type</th>
                                        <th>Contract Type</th>
                                        <th>Screening Type</th>
                                        <th>Clinic Name</th>
                                        <th>Procedure(s)</th>
                                       
                                        <th>Error Message(s)</th>
                                        <th>Total Billing</th>



                                        <th>Last Updated</th>
                                        <th>Created</th>

                                    </tr>
                                </thead>
                                @foreach (var item in Model)
                                {

                                    <tr>



                                        <td>

                                           


                                        </td>



                                        <td>

                                            

                                            @if (ViewBag.AgencySiteID == item.AgencySiteID || ViewBag.RoleBinID != 2) { 


                                            <a class="btn btn-default" id="ScreenButton_@item.ScreeningID" href="#">
                                            
                                            
                                                @if (item.BPPlus == false) { 

                                                if (item.BillingLevel > 0)
                                                {

                                                    <span style="color:#fff; font-weight:bold; font-size:14px; background-color:#56c23c; padding-top:2px; padding-bottom:2px; padding-left:7px; padding-right:7px; border-radius:5px; border:2px">@item.BillingLevel</span>

                                                }
                                                else if (item.BillingLevel == 0)
                                                {

                                                    <span style="color:#fff; font-weight:bold; font-size:14px; background-color:red; padding-top:2px; padding-bottom:2px; padding-left:7px; padding-right:7px; border-radius:5px; border:2px">@item.BillingLevel</span>

                                                }
                                                else
                                                {

                                                    <span style="color:#fff; font-weight:bold; font-size:14px; background-color:#999; padding-top:2px; padding-bottom:2px; padding-left:7px; padding-right:7px; border-radius:5px; border:2px"><span class="glyphicon glyphicon-ok"></span></span>

                                                }


                                                if (item.BillingPaidBinID == 3)
                                                {

                                                    <span style="font-size:16px; color:green" class="glyphicon glyphicon-usd"></span>


                                                }
                                                else if (item.BillingPaidBinID == 2)
                                                {

                                                    <span style="font-size:16px; color:#ccc" class="glyphicon glyphicon-sort"></span>

                                                }
                                                else if (item.BillingPaidBinID == 1)
                                                {

                                                    <span style="font-size:16px; color:#ccc" class="glyphicon glyphicon-usd"></span>


                                                }
                                                else
                                                {

                                                    <span style="font-size:8px; color:#ccc" class="glyphicon glyphicon-minus"></span><span style="font-size:8px; color:#ccc" class="glyphicon glyphicon-minus"></span>

                                                }
                                            
                                                    
                                                }
                                                else
                                                {
                                                    
                                                    <img src="~/Images/CoverageIconBPPLUS.png" />
                                                    
                                                    
                                                }
                                            
                                            
                                            @item.ScreeningID




                                            </a>


                                            <script type="text/javascript">


                                                $('#ScreenButton_@item.ScreeningID').click(function () {

                                                    $('#ClientSection').load('@Url.Action("Details", "Clients")', { id: @item.ClientID, id2:@item.ScreeningID });


                                                });


                                            </script>

                                            }
                                            else
                                            {


                                                if (item.BillingLevel != null)
                                                {

                                                    <span style="color:#fff; font-weight:bold; font-size:14px; background-color:#56c23c; padding-top:2px; padding-bottom:2px; padding-left:7px; padding-right:7px; border-radius:5px; border:2px">@item.BillingLevel</span>

                                                }
                                                else if (item.BillingLevel == 0)
                                                {

                                                    <span style="color:#fff; font-weight:bold; font-size:14px; background-color:#red; padding-top:2px; padding-bottom:2px; padding-left:7px; padding-right:7px; border-radius:5px; border:2px">@item.BillingLevel</span>

                                                }
                                                else
                                                {

                                                    <span style="color:#fff; font-weight:bold; font-size:14px; background-color:#999; padding-top:2px; padding-bottom:2px; padding-left:7px; padding-right:7px; border-radius:5px; border:2px"><span class="glyphicon glyphicon-ok"></span></span>

                                                }


                                                if (item.BillingPaidBinID == 3)
                                                {

                                                    <span style="font-size:16px; color:green" class="glyphicon glyphicon-usd"></span>


                                                }
                                                else if (item.BillingPaidBinID == 2)
                                                {

                                                    <span style="font-size:16px; color:#ccc" class="glyphicon glyphicon-sort"></span>

                                                }
                                                else if (item.BillingPaidBinID == 1)
                                                {

                                                    <span style="font-size:16px; color:#ccc" class="glyphicon glyphicon-usd"></span>


                                                }
                                                else
                                                {

                                                    <span style="font-size:8px; color:#ccc" class="glyphicon glyphicon-minus"></span><span style="font-size:8px; color:#ccc" class="glyphicon glyphicon-minus"></span>

                                                }



                                                @item.ScreeningID




                                            }




                                        </td>




                                        <td>@Html.FormatValue(item.ClinicalCycleDate, "{0:MM/dd/yyyy}")</td>


                                        @*<td>@item.ClientID</td>


                        @if (@ViewBag.RoleName != "ReadOnly")
                        {

                            <td>@item.ClientName</td>

                        }*@




                                        <td>

                                            @item.CancerTypeBinName
                                        </td>
                                        <td>@item.ContractTypeName</td>
                                        <td>@item.ScreeningType</td>
                                        <td>
                                            @item.ClinicName
                                        </td>

                                        @if (item.ProcScreeningCount > 0)
                                        {

                                            <td>@Html.Raw(string.Join(",", item.ProcScreeningList.ToArray()))</td>


                                        }
                                        else
                                        {


                                            <td><span style="font-style:italic;color:#ccc">There is currently (0) Procedures for this screening</span></td>

                                        }

                                       

                                        @if (item.MessageScreeningCount > 0)
                                        {

                                            <td> @Html.Raw(string.Join(",", item.MessageScreeningList.ToArray()))</td>

                                        }
                                        else
                                        {

                                            <td><span>--</span></td>

                                        }


                                        @if (item.TotalAllocation != null)
                                        {

                                            <td align="center">@item.TotalAllocation</td>

                                        }
                                        else
                                        {

                                            <td align="center"><span>--</span></td>

                                        }


                                        <td class="UpdateDates">


                                            @{
                                        string sDispTxt = "";
                                        string sDateDiffStr = "";
                                        DateTime? date1a = item.DateUpdated;
                                        DateTime date1 = Convert.ToDateTime(date1a);
                                        DateTime date2 = DateTime.Now;
                                        int oldMonth = date2.Month;
                                        while (oldMonth == date2.Month)
                                        {
                                            date1 = date1.AddDays(-1);
                                            date2 = date2.AddDays(-1);
                                        }


                                        int years = 0, months = 0, days = 0, hours = 0, minutes = 0, seconds = 0, milliseconds = 0;


                                        // getting number of years
                                        while (date2.CompareTo(date1) >= 0)
                                        {
                                            years++;
                                            date2 = date2.AddYears(-1);
                                        }
                                        date2 = date2.AddYears(1);
                                        years--;


                                        // getting number of months and days
                                        oldMonth = date2.Month;
                                        while (date2.CompareTo(date1) >= 0)
                                        {
                                            days++;
                                            date2 = date2.AddDays(-1);
                                            if ((date2.CompareTo(date1) >= 0) && (oldMonth != date2.Month))
                                            {
                                                months++;
                                                days = 0;
                                                oldMonth = date2.Month;
                                            }
                                        }
                                        date2 = date2.AddDays(1);
                                        days--;

                                        TimeSpan difference = date2.Subtract(date1);


                                        sDateDiffStr =
                                            "Difference: " +
                                            years.ToString() + " years" +
                                            ", " + months.ToString() + " months" +
                                            ", " + days.ToString() + " days" +
                                            ", " + difference.Hours.ToString() + " hours" +
                                            ", " + difference.Minutes.ToString() + " minutes" +
                                            ", " + difference.Seconds.ToString() + " seconds" +
                                            ", " + difference.Milliseconds.ToString() + " milliseconds";
                                        if (years >= 1)
                                        {
                                            sDispTxt = " years ago";
                                            if (years == 1)
                                            {
                                                sDispTxt = " year ago";
                                            }
                                            sDateDiffStr = years.ToString() + " " + sDispTxt;
                                        }
                                        else
                                        {
                                            if (months >= 1)
                                            {
                                                sDispTxt = " months ago";
                                                if (months == 1)
                                                {
                                                    sDispTxt = " month ago";
                                                }
                                                sDateDiffStr = months.ToString() + " " + sDispTxt;
                                            }
                                            else
                                            {
                                                if (days >= 1)
                                                {
                                                    sDispTxt = " days ago";
                                                    if (days == 1)
                                                    {
                                                        sDispTxt = " day ago";
                                                    }
                                                    sDateDiffStr = days.ToString() + " " + sDispTxt;
                                                }
                                                else
                                                {
                                                    sDateDiffStr = "0 days, " + difference.Minutes.ToString() + " minutes and " + difference.Seconds.ToString() + " seconds ago";
                                                }
                                            }
                                        }
                                            }

                                            @Html.FormatValue(item.DateUpdated, "{0:MM/dd/yyyy}") (@sDateDiffStr) by @item.UpdatedBy

                                        </td>

                                        <td>


                                            @Html.FormatValue(item.DateCreated, "{0:MM/dd/yyyy}") (@sDateDiffStr) by @item.CreatedBy

                                        </td>
                                        

                                    </tr>

                                }

                            </table>

                        </div>


                    </div>

                </div>

            </div>



        </div>

    </div>


</div>





<script type="text/javascript" charset="utf-8">


    @*$(document).ready( function () {


        $('#ScreeningList')
            .addClass( 'nowrap' )
            .dataTable({ 
                
                
                responsive: true,
                dom: 'Bfrtip',

                buttons: [

                {
                    extend: 'excelHtml5',
                    title: 'eCaST - @ViewBag.TileLabel',
                    exportOptions: {
                        columns: ':visible',
                        columns: [1, 2, 3, 4, 5, 6]
                    }
                },
                {
                    extend: 'pdfHtml5',
                    title: 'eCaST - @ViewBag.TileLabel',
                    exportOptions: {
                        columns: ':visible',
                        columns: [1, 2, 3, 4, 5, 6]
                    }
                }
                ],
                responsive: {
                    details: {
                        type: 'column'
                    }
                },
                columnDefs: [ {
                    className: 'control',
                    orderable: false,
                    targets:   0
                } ],
            
         
            
            }); 
    
    
    });*@



    $(document).ready(function () {
        oTable = $('#ScreeningList').dataTable({
            "sPaginationType": "full_numbers",
            "bSortClasses": false,
            // "aoColumnDefs": [{ "bVisible": false, "aTargets": [1] }],
            "aLengthMenu": [[5, 10, 25, 50, 100, 250, 500, -1], [5, 10, 25, 50, 100, 250, 500, "All"]],
            "bPaginate": true,
            "bAutoWidth": false,
            "bDestroy": true,
            "iDisplayLength": 10,
            dom: 'Bfrtip',

            buttons: [

            {
                extend: 'excelHtml5',
                title: 'eCaST - @ViewBag.TileLabel',
                exportOptions: {
                    columns: ':visible',
                    columns: [1, 2, 3, 4, 5, 6]
                }
            },
            {
                extend: 'pdfHtml5',
                title: 'eCaST - @ViewBag.TileLabel',
                exportOptions: {
                    columns: ':visible',
                    columns: [1, 2, 3, 4, 5, 6]
                }
            }
            ],
            responsive: {
                details: {
                    type: 'column'
                }
            },
            columnDefs: [ {
                className: 'control',
                orderable: false,
                targets:   0
            } ],
            "oLanguage": { "sSearch": "Filter: " }
        }).addClass( 'nowrap' );

        oTable.fnSort([[2, 'desc']]); // Sort by first column descending


    });

    $('#NewScreeningListButton').click(function () {

        $('#ContentContainer').load('@Url.Action("Create", "Screenings", new { id = ViewBag.ClientID })');
        $('#ExistingScreeningContainer').css("display","none");
        
    });

    $('#BillingSummaryButton').click(function () {

        $('#ErrorsContainer').load('@Url.Action("GetBillingInfo", "InvoiceDetails", new { id = ViewBag.ClientID })');


    });

</script>
